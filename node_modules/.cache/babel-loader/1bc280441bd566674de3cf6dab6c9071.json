{"ast":null,"code":"import _regeneratorRuntime from\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import{MaxUint256}from'@ethersproject/constants';import{Protocol,Trade}from'@uniswap/router-sdk';import{Pair,Route as V2Route,Trade as V2Trade}from'@uniswap/v2-sdk';import{Pool,Route as V3Route,Trade as V3Trade}from'@uniswap/v3-sdk';import{useCallback,useMemo}from'react';import{getTxOptimizedSwapRouter,SwapRouterVersion}from'utils/getTxOptimizedSwapRouter';import{SWAP_ROUTER_ADDRESSES,V2_ROUTER_ADDRESS,V3_ROUTER_ADDRESS}from'../constants/addresses';import{TransactionType}from'../state/transactions/actions';import{useHasPendingApproval,useTransactionAdder}from'../state/transactions/hooks';import{calculateGasMargin}from'../utils/calculateGasMargin';import{useTokenContract}from'./useContract';import{useTokenAllowance}from'./useTokenAllowance';import{useActiveWeb3React}from'./web3';export var ApprovalState;(function(ApprovalState){ApprovalState[\"UNKNOWN\"]=\"UNKNOWN\";ApprovalState[\"NOT_APPROVED\"]=\"NOT_APPROVED\";ApprovalState[\"PENDING\"]=\"PENDING\";ApprovalState[\"APPROVED\"]=\"APPROVED\";})(ApprovalState||(ApprovalState={}));export function useApprovalState(amountToApprove,spender){var _amountToApprove$curr;var _useActiveWeb3React=useActiveWeb3React(),account=_useActiveWeb3React.account;var token=(amountToApprove===null||amountToApprove===void 0?void 0:(_amountToApprove$curr=amountToApprove.currency)===null||_amountToApprove$curr===void 0?void 0:_amountToApprove$curr.isToken)?amountToApprove.currency:undefined;var currentAllowance=useTokenAllowance(token,account!==null&&account!==void 0?account:undefined,spender);var pendingApproval=useHasPendingApproval(token===null||token===void 0?void 0:token.address,spender);return useMemo(function(){if(!amountToApprove||!spender)return ApprovalState.UNKNOWN;if(amountToApprove.currency.isNative)return ApprovalState.APPROVED;// we might not have enough data to know whether or not we need to approve\nif(!currentAllowance)return ApprovalState.UNKNOWN;// amountToApprove will be defined if currentAllowance is\nreturn currentAllowance.lessThan(amountToApprove)?pendingApproval?ApprovalState.PENDING:ApprovalState.NOT_APPROVED:ApprovalState.APPROVED;},[amountToApprove,currentAllowance,pendingApproval,spender]);}/** Returns approval state for all known swap routers */export function useAllApprovalStates(trade,allowedSlippage){var _useActiveWeb3React2=useActiveWeb3React(),chainId=_useActiveWeb3React2.chainId;var amountToApprove=useMemo(function(){return trade&&trade.inputAmount.currency.isToken?trade.maximumAmountIn(allowedSlippage):undefined;},[trade,allowedSlippage]);var v2ApprovalState=useApprovalState(amountToApprove,chainId?V2_ROUTER_ADDRESS[chainId]:undefined);var v3ApprovalState=useApprovalState(amountToApprove,chainId?V3_ROUTER_ADDRESS[chainId]:undefined);var v2V3ApprovalState=useApprovalState(amountToApprove,chainId?SWAP_ROUTER_ADDRESSES[chainId]:undefined);return useMemo(function(){return{v2:v2ApprovalState,v3:v3ApprovalState,v2V3:v2V3ApprovalState};},[v2ApprovalState,v2V3ApprovalState,v3ApprovalState]);}// returns a variable indicating the state of the approval and a function which approves if necessary or early returns\nexport function useApproveCallback(amountToApprove,spender){var _amountToApprove$curr2;var _useActiveWeb3React3=useActiveWeb3React(),chainId=_useActiveWeb3React3.chainId;var token=(amountToApprove===null||amountToApprove===void 0?void 0:(_amountToApprove$curr2=amountToApprove.currency)===null||_amountToApprove$curr2===void 0?void 0:_amountToApprove$curr2.isToken)?amountToApprove.currency:undefined;// check the current approval status\nvar approvalState=useApprovalState(amountToApprove,spender);var tokenContract=useTokenContract(token===null||token===void 0?void 0:token.address);var addTransaction=useTransactionAdder();var approve=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var useExact,estimatedGas;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(approvalState!==ApprovalState.NOT_APPROVED)){_context.next=3;break;}console.error('approve was called unnecessarily');return _context.abrupt(\"return\");case 3:if(chainId){_context.next=6;break;}console.error('no chainId');return _context.abrupt(\"return\");case 6:if(token){_context.next=9;break;}console.error('no token');return _context.abrupt(\"return\");case 9:if(tokenContract){_context.next=12;break;}console.error('tokenContract is null');return _context.abrupt(\"return\");case 12:if(amountToApprove){_context.next=15;break;}console.error('missing amount to approve');return _context.abrupt(\"return\");case 15:if(spender){_context.next=18;break;}console.error('no spender');return _context.abrupt(\"return\");case 18:useExact=false;_context.next=21;return tokenContract.estimateGas.approve(spender,MaxUint256).catch(function(){// general fallback for tokens who restrict approval amounts\nuseExact=true;return tokenContract.estimateGas.approve(spender,amountToApprove.quotient.toString());});case 21:estimatedGas=_context.sent;return _context.abrupt(\"return\",tokenContract.approve(spender,useExact?amountToApprove.quotient.toString():MaxUint256,{gasLimit:calculateGasMargin(estimatedGas)}).then(function(response){addTransaction(response,{type:TransactionType.APPROVAL,tokenAddress:token.address,spender:spender});}).catch(function(error){console.debug('Failed to approve token',error);throw error;}));case 23:case\"end\":return _context.stop();}}},_callee);})),[approvalState,token,tokenContract,amountToApprove,spender,addTransaction,chainId]);return[approvalState,approve];}// wraps useApproveCallback in the context of a swap\nexport function useApproveCallbackFromTrade(trade,allowedSlippage){var _useActiveWeb3React4=useActiveWeb3React(),chainId=_useActiveWeb3React4.chainId;var amountToApprove=useMemo(function(){return trade&&trade.inputAmount.currency.isToken?trade.maximumAmountIn(allowedSlippage):undefined;},[trade,allowedSlippage]);var approveCallback=useApproveCallback(amountToApprove,chainId?trade instanceof V2Trade?V2_ROUTER_ADDRESS[chainId]:trade instanceof V3Trade?V3_ROUTER_ADDRESS[chainId]:SWAP_ROUTER_ADDRESSES[chainId]:undefined);// TODO: remove L162-168 after testing is done. This error will help detect mistakes in the logic.\nif(Trade instanceof V2Trade&&approveCallback[0]!==ApprovalState.APPROVED||trade instanceof V3Trade&&approveCallback[0]!==ApprovalState.APPROVED){throw new Error('Trying to approve legacy router');}return approveCallback;}export function useApprovalOptimizedTrade(trade,allowedSlippage){var _trade$routes$length;var onlyV2Routes=trade===null||trade===void 0?void 0:trade.routes.every(function(route){return route.protocol===Protocol.V2;});var onlyV3Routes=trade===null||trade===void 0?void 0:trade.routes.every(function(route){return route.protocol===Protocol.V3;});var tradeHasSplits=((_trade$routes$length=trade===null||trade===void 0?void 0:trade.routes.length)!==null&&_trade$routes$length!==void 0?_trade$routes$length:0)>1;var approvalStates=useAllApprovalStates(trade,allowedSlippage);var optimizedSwapRouter=useMemo(function(){return getTxOptimizedSwapRouter({onlyV2Routes:onlyV2Routes,onlyV3Routes:onlyV3Routes,tradeHasSplits:tradeHasSplits,approvalStates:approvalStates});},[approvalStates,tradeHasSplits,onlyV2Routes,onlyV3Routes]);return useMemo(function(){if(!trade)return undefined;try{switch(optimizedSwapRouter){case SwapRouterVersion.V2V3:return trade;case SwapRouterVersion.V2:var pairs=trade.swaps[0].route.pools.filter(function(pool){return pool instanceof Pair;});var v2Route=new V2Route(pairs,trade.inputAmount.currency,trade.outputAmount.currency);return new V2Trade(v2Route,trade.inputAmount,trade.tradeType);case SwapRouterVersion.V3:return V3Trade.createUncheckedTradeWithMultipleRoutes({routes:trade.swaps.map(function(_ref2){var route=_ref2.route,inputAmount=_ref2.inputAmount,outputAmount=_ref2.outputAmount;return{route:new V3Route(route.pools.filter(function(p){return p instanceof Pool;}),inputAmount.currency,outputAmount.currency),inputAmount:inputAmount,outputAmount:outputAmount};}),tradeType:trade.tradeType});default:return undefined;}}catch(e){// TODO(#2989): remove try-catch\nconsole.debug(e);return undefined;}},[trade,optimizedSwapRouter]);}","map":{"version":3,"sources":["/Users/safahi/Downloads/interface-4.30.1/src/hooks/useApproveCallback.ts"],"names":["MaxUint256","Protocol","Trade","Pair","Route","V2Route","V2Trade","Pool","V3Route","V3Trade","useCallback","useMemo","getTxOptimizedSwapRouter","SwapRouterVersion","SWAP_ROUTER_ADDRESSES","V2_ROUTER_ADDRESS","V3_ROUTER_ADDRESS","TransactionType","useHasPendingApproval","useTransactionAdder","calculateGasMargin","useTokenContract","useTokenAllowance","useActiveWeb3React","ApprovalState","useApprovalState","amountToApprove","spender","account","token","currency","isToken","undefined","currentAllowance","pendingApproval","address","UNKNOWN","isNative","APPROVED","lessThan","PENDING","NOT_APPROVED","useAllApprovalStates","trade","allowedSlippage","chainId","inputAmount","maximumAmountIn","v2ApprovalState","v3ApprovalState","v2V3ApprovalState","v2","v3","v2V3","useApproveCallback","approvalState","tokenContract","addTransaction","approve","console","error","useExact","estimateGas","catch","quotient","toString","estimatedGas","gasLimit","then","response","type","APPROVAL","tokenAddress","debug","useApproveCallbackFromTrade","approveCallback","Error","useApprovalOptimizedTrade","onlyV2Routes","routes","every","route","protocol","V2","onlyV3Routes","V3","tradeHasSplits","length","approvalStates","optimizedSwapRouter","V2V3","pairs","swaps","pools","filter","pool","v2Route","outputAmount","tradeType","createUncheckedTradeWithMultipleRoutes","map","p","e"],"mappings":"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","sourcesContent":["import { MaxUint256 } from '@ethersproject/constants'\nimport { TransactionResponse } from '@ethersproject/providers'\nimport { Protocol, Trade } from '@uniswap/router-sdk'\nimport { Currency, CurrencyAmount, Percent, TradeType } from '@uniswap/sdk-core'\nimport { Pair, Route as V2Route, Trade as V2Trade } from '@uniswap/v2-sdk'\nimport { Pool, Route as V3Route, Trade as V3Trade } from '@uniswap/v3-sdk'\nimport { useCallback, useMemo } from 'react'\nimport { getTxOptimizedSwapRouter, SwapRouterVersion } from 'utils/getTxOptimizedSwapRouter'\n\nimport { SWAP_ROUTER_ADDRESSES, V2_ROUTER_ADDRESS, V3_ROUTER_ADDRESS } from '../constants/addresses'\nimport { TransactionType } from '../state/transactions/actions'\nimport { useHasPendingApproval, useTransactionAdder } from '../state/transactions/hooks'\nimport { calculateGasMargin } from '../utils/calculateGasMargin'\nimport { useTokenContract } from './useContract'\nimport { useTokenAllowance } from './useTokenAllowance'\nimport { useActiveWeb3React } from './web3'\n\nexport enum ApprovalState {\n  UNKNOWN = 'UNKNOWN',\n  NOT_APPROVED = 'NOT_APPROVED',\n  PENDING = 'PENDING',\n  APPROVED = 'APPROVED',\n}\n\nexport function useApprovalState(amountToApprove?: CurrencyAmount<Currency>, spender?: string) {\n  const { account } = useActiveWeb3React()\n  const token = amountToApprove?.currency?.isToken ? amountToApprove.currency : undefined\n\n  const currentAllowance = useTokenAllowance(token, account ?? undefined, spender)\n  const pendingApproval = useHasPendingApproval(token?.address, spender)\n\n  return useMemo(() => {\n    if (!amountToApprove || !spender) return ApprovalState.UNKNOWN\n    if (amountToApprove.currency.isNative) return ApprovalState.APPROVED\n    // we might not have enough data to know whether or not we need to approve\n    if (!currentAllowance) return ApprovalState.UNKNOWN\n\n    // amountToApprove will be defined if currentAllowance is\n    return currentAllowance.lessThan(amountToApprove)\n      ? pendingApproval\n        ? ApprovalState.PENDING\n        : ApprovalState.NOT_APPROVED\n      : ApprovalState.APPROVED\n  }, [amountToApprove, currentAllowance, pendingApproval, spender])\n}\n\n/** Returns approval state for all known swap routers */\nexport function useAllApprovalStates(\n  trade: Trade<Currency, Currency, TradeType> | undefined,\n  allowedSlippage: Percent\n) {\n  const { chainId } = useActiveWeb3React()\n\n  const amountToApprove = useMemo(\n    () => (trade && trade.inputAmount.currency.isToken ? trade.maximumAmountIn(allowedSlippage) : undefined),\n    [trade, allowedSlippage]\n  )\n\n  const v2ApprovalState = useApprovalState(amountToApprove, chainId ? V2_ROUTER_ADDRESS[chainId] : undefined)\n  const v3ApprovalState = useApprovalState(amountToApprove, chainId ? V3_ROUTER_ADDRESS[chainId] : undefined)\n  const v2V3ApprovalState = useApprovalState(amountToApprove, chainId ? SWAP_ROUTER_ADDRESSES[chainId] : undefined)\n\n  return useMemo(\n    () => ({ v2: v2ApprovalState, v3: v3ApprovalState, v2V3: v2V3ApprovalState }),\n    [v2ApprovalState, v2V3ApprovalState, v3ApprovalState]\n  )\n}\n\n// returns a variable indicating the state of the approval and a function which approves if necessary or early returns\nexport function useApproveCallback(\n  amountToApprove?: CurrencyAmount<Currency>,\n  spender?: string\n): [ApprovalState, () => Promise<void>] {\n  const { chainId } = useActiveWeb3React()\n  const token = amountToApprove?.currency?.isToken ? amountToApprove.currency : undefined\n\n  // check the current approval status\n  const approvalState = useApprovalState(amountToApprove, spender)\n\n  const tokenContract = useTokenContract(token?.address)\n  const addTransaction = useTransactionAdder()\n\n  const approve = useCallback(async (): Promise<void> => {\n    if (approvalState !== ApprovalState.NOT_APPROVED) {\n      console.error('approve was called unnecessarily')\n      return\n    }\n    if (!chainId) {\n      console.error('no chainId')\n      return\n    }\n\n    if (!token) {\n      console.error('no token')\n      return\n    }\n\n    if (!tokenContract) {\n      console.error('tokenContract is null')\n      return\n    }\n\n    if (!amountToApprove) {\n      console.error('missing amount to approve')\n      return\n    }\n\n    if (!spender) {\n      console.error('no spender')\n      return\n    }\n\n    let useExact = false\n    const estimatedGas = await tokenContract.estimateGas.approve(spender, MaxUint256).catch(() => {\n      // general fallback for tokens who restrict approval amounts\n      useExact = true\n      return tokenContract.estimateGas.approve(spender, amountToApprove.quotient.toString())\n    })\n\n    return tokenContract\n      .approve(spender, useExact ? amountToApprove.quotient.toString() : MaxUint256, {\n        gasLimit: calculateGasMargin(estimatedGas),\n      })\n      .then((response: TransactionResponse) => {\n        addTransaction(response, { type: TransactionType.APPROVAL, tokenAddress: token.address, spender })\n      })\n      .catch((error: Error) => {\n        console.debug('Failed to approve token', error)\n        throw error\n      })\n  }, [approvalState, token, tokenContract, amountToApprove, spender, addTransaction, chainId])\n\n  return [approvalState, approve]\n}\n\n// wraps useApproveCallback in the context of a swap\nexport function useApproveCallbackFromTrade(\n  trade:\n    | V2Trade<Currency, Currency, TradeType>\n    | V3Trade<Currency, Currency, TradeType>\n    | Trade<Currency, Currency, TradeType>\n    | undefined,\n  allowedSlippage: Percent\n) {\n  const { chainId } = useActiveWeb3React()\n  const amountToApprove = useMemo(\n    () => (trade && trade.inputAmount.currency.isToken ? trade.maximumAmountIn(allowedSlippage) : undefined),\n    [trade, allowedSlippage]\n  )\n\n  const approveCallback = useApproveCallback(\n    amountToApprove,\n    chainId\n      ? trade instanceof V2Trade\n        ? V2_ROUTER_ADDRESS[chainId]\n        : trade instanceof V3Trade\n        ? V3_ROUTER_ADDRESS[chainId]\n        : SWAP_ROUTER_ADDRESSES[chainId]\n      : undefined\n  )\n\n  // TODO: remove L162-168 after testing is done. This error will help detect mistakes in the logic.\n  if (\n    (Trade instanceof V2Trade && approveCallback[0] !== ApprovalState.APPROVED) ||\n    (trade instanceof V3Trade && approveCallback[0] !== ApprovalState.APPROVED)\n  ) {\n    throw new Error('Trying to approve legacy router')\n  }\n\n  return approveCallback\n}\n\nexport function useApprovalOptimizedTrade(\n  trade: Trade<Currency, Currency, TradeType> | undefined,\n  allowedSlippage: Percent\n):\n  | V2Trade<Currency, Currency, TradeType>\n  | V3Trade<Currency, Currency, TradeType>\n  | Trade<Currency, Currency, TradeType>\n  | undefined {\n  const onlyV2Routes = trade?.routes.every((route) => route.protocol === Protocol.V2)\n  const onlyV3Routes = trade?.routes.every((route) => route.protocol === Protocol.V3)\n  const tradeHasSplits = (trade?.routes.length ?? 0) > 1\n\n  const approvalStates = useAllApprovalStates(trade, allowedSlippage)\n\n  const optimizedSwapRouter = useMemo(\n    () => getTxOptimizedSwapRouter({ onlyV2Routes, onlyV3Routes, tradeHasSplits, approvalStates }),\n    [approvalStates, tradeHasSplits, onlyV2Routes, onlyV3Routes]\n  )\n\n  return useMemo(() => {\n    if (!trade) return undefined\n\n    try {\n      switch (optimizedSwapRouter) {\n        case SwapRouterVersion.V2V3:\n          return trade\n        case SwapRouterVersion.V2:\n          const pairs = trade.swaps[0].route.pools.filter((pool) => pool instanceof Pair) as Pair[]\n          const v2Route = new V2Route(pairs, trade.inputAmount.currency, trade.outputAmount.currency)\n          return new V2Trade(v2Route, trade.inputAmount, trade.tradeType)\n        case SwapRouterVersion.V3:\n          return V3Trade.createUncheckedTradeWithMultipleRoutes({\n            routes: trade.swaps.map(({ route, inputAmount, outputAmount }) => ({\n              route: new V3Route(\n                route.pools.filter((p) => p instanceof Pool) as Pool[],\n                inputAmount.currency,\n                outputAmount.currency\n              ),\n              inputAmount,\n              outputAmount,\n            })),\n            tradeType: trade.tradeType,\n          })\n        default:\n          return undefined\n      }\n    } catch (e) {\n      // TODO(#2989): remove try-catch\n      console.debug(e)\n      return undefined\n    }\n  }, [trade, optimizedSwapRouter])\n}\n"]},"metadata":{},"sourceType":"module"}