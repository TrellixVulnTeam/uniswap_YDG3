{"ast":null,"code":"import _defineProperty from\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _slicedToArray from\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import{skipToken}from'@reduxjs/toolkit/query/react';import{FeeAmount}from'@uniswap/v3-sdk';import{useMemo}from'react';import ReactGA from'react-ga';import{useBlockNumber}from'state/application/hooks';import{useFeeTierDistributionQuery}from'state/data/enhanced';import{PoolState,usePool}from'./usePools';// maximum number of blocks past which we consider the data stale\nvar MAX_DATA_BLOCK_AGE=20;export function useFeeTierDistribution(currencyA,currencyB){var _usePoolTVL=usePoolTVL(currencyA===null||currencyA===void 0?void 0:currencyA.wrapped,currencyB===null||currencyB===void 0?void 0:currencyB.wrapped),isFetching=_usePoolTVL.isFetching,isLoading=_usePoolTVL.isLoading,isUninitialized=_usePoolTVL.isUninitialized,isError=_usePoolTVL.isError,distributions=_usePoolTVL.distributions;// fetch all pool states to determine pool state\nvar _usePool=usePool(currencyA,currencyB,FeeAmount.LOWEST),_usePool2=_slicedToArray(_usePool,1),poolStateVeryLow=_usePool2[0];var _usePool3=usePool(currencyA,currencyB,FeeAmount.LOW),_usePool4=_slicedToArray(_usePool3,1),poolStateLow=_usePool4[0];var _usePool5=usePool(currencyA,currencyB,FeeAmount.MEDIUM),_usePool6=_slicedToArray(_usePool5,1),poolStateMedium=_usePool6[0];var _usePool7=usePool(currencyA,currencyB,FeeAmount.HIGH),_usePool8=_slicedToArray(_usePool7,1),poolStateHigh=_usePool8[0];return useMemo(function(){var _distributions$FeeAmo,_distributions$FeeAmo2,_distributions$FeeAmo3,_distributions$FeeAmo4,_ref;if(isLoading||isFetching||isUninitialized||isError||!distributions){return{isLoading:isLoading||isFetching||!isUninitialized,isError:isError,distributions:distributions};}var largestUsageFeeTier=Object.keys(distributions).map(function(d){return Number(d);}).filter(function(d){return distributions[d]!==0&&distributions[d]!==undefined;}).reduce(function(a,b){var _distributions$a,_distributions$b;return((_distributions$a=distributions[a])!==null&&_distributions$a!==void 0?_distributions$a:0)>((_distributions$b=distributions[b])!==null&&_distributions$b!==void 0?_distributions$b:0)?a:b;},-1);var percentages=!isLoading&&!isError&&distributions&&poolStateVeryLow!==PoolState.LOADING&&poolStateLow!==PoolState.LOADING&&poolStateMedium!==PoolState.LOADING&&poolStateHigh!==PoolState.LOADING?(_ref={},_defineProperty(_ref,FeeAmount.LOWEST,poolStateVeryLow===PoolState.EXISTS?((_distributions$FeeAmo=distributions[FeeAmount.LOWEST])!==null&&_distributions$FeeAmo!==void 0?_distributions$FeeAmo:0)*100:undefined),_defineProperty(_ref,FeeAmount.LOW,poolStateLow===PoolState.EXISTS?((_distributions$FeeAmo2=distributions[FeeAmount.LOW])!==null&&_distributions$FeeAmo2!==void 0?_distributions$FeeAmo2:0)*100:undefined),_defineProperty(_ref,FeeAmount.MEDIUM,poolStateMedium===PoolState.EXISTS?((_distributions$FeeAmo3=distributions[FeeAmount.MEDIUM])!==null&&_distributions$FeeAmo3!==void 0?_distributions$FeeAmo3:0)*100:undefined),_defineProperty(_ref,FeeAmount.HIGH,poolStateHigh===PoolState.EXISTS?((_distributions$FeeAmo4=distributions[FeeAmount.HIGH])!==null&&_distributions$FeeAmo4!==void 0?_distributions$FeeAmo4:0)*100:undefined),_ref):undefined;return{isLoading:isLoading,isError:isError,distributions:percentages,largestUsageFeeTier:largestUsageFeeTier===-1?undefined:largestUsageFeeTier};},[isLoading,isFetching,isUninitialized,isError,distributions,poolStateVeryLow,poolStateLow,poolStateMedium,poolStateHigh]);}function usePoolTVL(token0,token1){var _ref3;var latestBlock=useBlockNumber();var _useFeeTierDistributi=useFeeTierDistributionQuery(token0&&token1?{token0:token0.address.toLowerCase(),token1:token1.address.toLowerCase()}:skipToken,{pollingInterval:30000}),isLoading=_useFeeTierDistributi.isLoading,isFetching=_useFeeTierDistributi.isFetching,isUninitialized=_useFeeTierDistributi.isUninitialized,isError=_useFeeTierDistributi.isError,data=_useFeeTierDistributi.data;var _ref2=(_ref3=data)!==null&&_ref3!==void 0?_ref3:{},asToken0=_ref2.asToken0,asToken1=_ref2.asToken1,_meta=_ref2._meta;return useMemo(function(){var _meta$block$number,_meta$block,_all$reduce,_distributions;if(!latestBlock||!_meta||!asToken0||!asToken1){return{isLoading:isLoading,isFetching:isFetching,isUninitialized:isUninitialized,isError:isError};}if(latestBlock-((_meta$block$number=_meta===null||_meta===void 0?void 0:(_meta$block=_meta.block)===null||_meta$block===void 0?void 0:_meta$block.number)!==null&&_meta$block$number!==void 0?_meta$block$number:0)>MAX_DATA_BLOCK_AGE){ReactGA.exception({description:\"Graph stale (latest block: \".concat(latestBlock,\")\")});return{isLoading:isLoading,isFetching:isFetching,isUninitialized:isUninitialized,isError:isError};}var all=asToken0.concat(asToken1);// sum tvl for token0 and token1 by fee tier\nvar tvlByFeeTier=all.reduce(function(acc,value){var _acc$value$feeTier$,_acc$value$feeTier$2;acc[value.feeTier][0]=((_acc$value$feeTier$=acc[value.feeTier][0])!==null&&_acc$value$feeTier$!==void 0?_acc$value$feeTier$:0)+Number(value.totalValueLockedToken0);acc[value.feeTier][1]=((_acc$value$feeTier$2=acc[value.feeTier][1])!==null&&_acc$value$feeTier$2!==void 0?_acc$value$feeTier$2:0)+Number(value.totalValueLockedToken1);return acc;},(_all$reduce={},_defineProperty(_all$reduce,FeeAmount.LOWEST,[undefined,undefined]),_defineProperty(_all$reduce,FeeAmount.LOW,[undefined,undefined]),_defineProperty(_all$reduce,FeeAmount.MEDIUM,[undefined,undefined]),_defineProperty(_all$reduce,FeeAmount.HIGH,[undefined,undefined]),_all$reduce));// sum total tvl for token0 and token1\nvar _Object$values$reduce=Object.values(tvlByFeeTier).reduce(function(acc,value){var _value$,_value$2;acc[0]+=(_value$=value[0])!==null&&_value$!==void 0?_value$:0;acc[1]+=(_value$2=value[1])!==null&&_value$2!==void 0?_value$2:0;return acc;},[0,0]),_Object$values$reduce2=_slicedToArray(_Object$values$reduce,2),sumToken0Tvl=_Object$values$reduce2[0],sumToken1Tvl=_Object$values$reduce2[1];// returns undefined if both tvl0 and tvl1 are undefined (pool not created)\nvar mean=function mean(tvl0,sumTvl0,tvl1,sumTvl1){return tvl0===undefined&&tvl1===undefined?undefined:((tvl0!==null&&tvl0!==void 0?tvl0:0)+(tvl1!==null&&tvl1!==void 0?tvl1:0))/(sumTvl0+sumTvl1)||0;};var distributions=(_distributions={},_defineProperty(_distributions,FeeAmount.LOWEST,mean(tvlByFeeTier[FeeAmount.LOWEST][0],sumToken0Tvl,tvlByFeeTier[FeeAmount.LOWEST][1],sumToken1Tvl)),_defineProperty(_distributions,FeeAmount.LOW,mean(tvlByFeeTier[FeeAmount.LOW][0],sumToken0Tvl,tvlByFeeTier[FeeAmount.LOW][1],sumToken1Tvl)),_defineProperty(_distributions,FeeAmount.MEDIUM,mean(tvlByFeeTier[FeeAmount.MEDIUM][0],sumToken0Tvl,tvlByFeeTier[FeeAmount.MEDIUM][1],sumToken1Tvl)),_defineProperty(_distributions,FeeAmount.HIGH,mean(tvlByFeeTier[FeeAmount.HIGH][0],sumToken0Tvl,tvlByFeeTier[FeeAmount.HIGH][1],sumToken1Tvl)),_distributions);return{isLoading:isLoading,isFetching:isFetching,isUninitialized:isUninitialized,isError:isError,distributions:distributions};},[_meta,asToken0,asToken1,isLoading,isError,isFetching,isUninitialized,latestBlock]);}","map":{"version":3,"sources":["/Users/safahi/Downloads/interface-4.30.1/src/hooks/useFeeTierDistribution.ts"],"names":["skipToken","FeeAmount","useMemo","ReactGA","useBlockNumber","useFeeTierDistributionQuery","PoolState","usePool","MAX_DATA_BLOCK_AGE","useFeeTierDistribution","currencyA","currencyB","usePoolTVL","wrapped","isFetching","isLoading","isUninitialized","isError","distributions","LOWEST","poolStateVeryLow","LOW","poolStateLow","MEDIUM","poolStateMedium","HIGH","poolStateHigh","largestUsageFeeTier","Object","keys","map","d","Number","filter","undefined","reduce","a","b","percentages","LOADING","EXISTS","token0","token1","latestBlock","address","toLowerCase","pollingInterval","data","asToken0","asToken1","_meta","block","number","exception","description","all","concat","tvlByFeeTier","acc","value","feeTier","totalValueLockedToken0","totalValueLockedToken1","values","sumToken0Tvl","sumToken1Tvl","mean","tvl0","sumTvl0","tvl1","sumTvl1"],"mappings":"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","sourcesContent":["import { skipToken } from '@reduxjs/toolkit/query/react'\nimport { Currency, Token } from '@uniswap/sdk-core'\nimport { FeeAmount } from '@uniswap/v3-sdk'\nimport ms from 'ms.macro'\nimport { useMemo } from 'react'\nimport ReactGA from 'react-ga'\nimport { useBlockNumber } from 'state/application/hooks'\nimport { useFeeTierDistributionQuery } from 'state/data/enhanced'\nimport { FeeTierDistributionQuery } from 'state/data/generated'\n\nimport { PoolState, usePool } from './usePools'\n\n// maximum number of blocks past which we consider the data stale\nconst MAX_DATA_BLOCK_AGE = 20\n\ninterface FeeTierDistribution {\n  isLoading: boolean\n  isError: boolean\n  largestUsageFeeTier?: FeeAmount | undefined\n\n  // distributions as percentages of overall liquidity\n  distributions?: Record<FeeAmount, number | undefined>\n}\n\nexport function useFeeTierDistribution(\n  currencyA: Currency | undefined,\n  currencyB: Currency | undefined\n): FeeTierDistribution {\n  const { isFetching, isLoading, isUninitialized, isError, distributions } = usePoolTVL(\n    currencyA?.wrapped,\n    currencyB?.wrapped\n  )\n\n  // fetch all pool states to determine pool state\n  const [poolStateVeryLow] = usePool(currencyA, currencyB, FeeAmount.LOWEST)\n  const [poolStateLow] = usePool(currencyA, currencyB, FeeAmount.LOW)\n  const [poolStateMedium] = usePool(currencyA, currencyB, FeeAmount.MEDIUM)\n  const [poolStateHigh] = usePool(currencyA, currencyB, FeeAmount.HIGH)\n\n  return useMemo(() => {\n    if (isLoading || isFetching || isUninitialized || isError || !distributions) {\n      return {\n        isLoading: isLoading || isFetching || !isUninitialized,\n        isError,\n        distributions,\n      }\n    }\n\n    const largestUsageFeeTier = Object.keys(distributions)\n      .map((d) => Number(d))\n      .filter((d: FeeAmount) => distributions[d] !== 0 && distributions[d] !== undefined)\n      .reduce((a: FeeAmount, b: FeeAmount) => ((distributions[a] ?? 0) > (distributions[b] ?? 0) ? a : b), -1)\n\n    const percentages =\n      !isLoading &&\n      !isError &&\n      distributions &&\n      poolStateVeryLow !== PoolState.LOADING &&\n      poolStateLow !== PoolState.LOADING &&\n      poolStateMedium !== PoolState.LOADING &&\n      poolStateHigh !== PoolState.LOADING\n        ? {\n            [FeeAmount.LOWEST]:\n              poolStateVeryLow === PoolState.EXISTS ? (distributions[FeeAmount.LOWEST] ?? 0) * 100 : undefined,\n            [FeeAmount.LOW]: poolStateLow === PoolState.EXISTS ? (distributions[FeeAmount.LOW] ?? 0) * 100 : undefined,\n            [FeeAmount.MEDIUM]:\n              poolStateMedium === PoolState.EXISTS ? (distributions[FeeAmount.MEDIUM] ?? 0) * 100 : undefined,\n            [FeeAmount.HIGH]:\n              poolStateHigh === PoolState.EXISTS ? (distributions[FeeAmount.HIGH] ?? 0) * 100 : undefined,\n          }\n        : undefined\n\n    return {\n      isLoading,\n      isError,\n      distributions: percentages,\n      largestUsageFeeTier: largestUsageFeeTier === -1 ? undefined : largestUsageFeeTier,\n    }\n  }, [\n    isLoading,\n    isFetching,\n    isUninitialized,\n    isError,\n    distributions,\n    poolStateVeryLow,\n    poolStateLow,\n    poolStateMedium,\n    poolStateHigh,\n  ])\n}\n\nfunction usePoolTVL(token0: Token | undefined, token1: Token | undefined) {\n  const latestBlock = useBlockNumber()\n\n  const { isLoading, isFetching, isUninitialized, isError, data } = useFeeTierDistributionQuery(\n    token0 && token1 ? { token0: token0.address.toLowerCase(), token1: token1.address.toLowerCase() } : skipToken,\n    {\n      pollingInterval: ms`30s`,\n    }\n  )\n\n  const { asToken0, asToken1, _meta } = (data as FeeTierDistributionQuery) ?? {}\n\n  return useMemo(() => {\n    if (!latestBlock || !_meta || !asToken0 || !asToken1) {\n      return {\n        isLoading,\n        isFetching,\n        isUninitialized,\n        isError,\n      }\n    }\n\n    if (latestBlock - (_meta?.block?.number ?? 0) > MAX_DATA_BLOCK_AGE) {\n      ReactGA.exception({\n        description: `Graph stale (latest block: ${latestBlock})`,\n      })\n\n      return {\n        isLoading,\n        isFetching,\n        isUninitialized,\n        isError,\n      }\n    }\n\n    const all = asToken0.concat(asToken1)\n\n    // sum tvl for token0 and token1 by fee tier\n    const tvlByFeeTier = all.reduce<{ [feeAmount: number]: [number | undefined, number | undefined] }>(\n      (acc, value) => {\n        acc[value.feeTier][0] = (acc[value.feeTier][0] ?? 0) + Number(value.totalValueLockedToken0)\n        acc[value.feeTier][1] = (acc[value.feeTier][1] ?? 0) + Number(value.totalValueLockedToken1)\n        return acc\n      },\n      {\n        [FeeAmount.LOWEST]: [undefined, undefined],\n        [FeeAmount.LOW]: [undefined, undefined],\n        [FeeAmount.MEDIUM]: [undefined, undefined],\n        [FeeAmount.HIGH]: [undefined, undefined],\n      } as Record<FeeAmount, [number | undefined, number | undefined]>\n    )\n\n    // sum total tvl for token0 and token1\n    const [sumToken0Tvl, sumToken1Tvl] = Object.values(tvlByFeeTier).reduce(\n      (acc: [number, number], value) => {\n        acc[0] += value[0] ?? 0\n        acc[1] += value[1] ?? 0\n        return acc\n      },\n      [0, 0]\n    )\n\n    // returns undefined if both tvl0 and tvl1 are undefined (pool not created)\n    const mean = (tvl0: number | undefined, sumTvl0: number, tvl1: number | undefined, sumTvl1: number) =>\n      tvl0 === undefined && tvl1 === undefined ? undefined : ((tvl0 ?? 0) + (tvl1 ?? 0)) / (sumTvl0 + sumTvl1) || 0\n\n    const distributions: Record<FeeAmount, number | undefined> = {\n      [FeeAmount.LOWEST]: mean(\n        tvlByFeeTier[FeeAmount.LOWEST][0],\n        sumToken0Tvl,\n        tvlByFeeTier[FeeAmount.LOWEST][1],\n        sumToken1Tvl\n      ),\n      [FeeAmount.LOW]: mean(tvlByFeeTier[FeeAmount.LOW][0], sumToken0Tvl, tvlByFeeTier[FeeAmount.LOW][1], sumToken1Tvl),\n      [FeeAmount.MEDIUM]: mean(\n        tvlByFeeTier[FeeAmount.MEDIUM][0],\n        sumToken0Tvl,\n        tvlByFeeTier[FeeAmount.MEDIUM][1],\n        sumToken1Tvl\n      ),\n      [FeeAmount.HIGH]: mean(\n        tvlByFeeTier[FeeAmount.HIGH][0],\n        sumToken0Tvl,\n        tvlByFeeTier[FeeAmount.HIGH][1],\n        sumToken1Tvl\n      ),\n    }\n\n    return {\n      isLoading,\n      isFetching,\n      isUninitialized,\n      isError,\n      distributions,\n    }\n  }, [_meta, asToken0, asToken1, isLoading, isError, isFetching, isUninitialized, latestBlock])\n}\n"]},"metadata":{},"sourceType":"module"}