{"ast":null,"code":"\"use strict\"; // Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\n\nvar _classCallCheck = require(\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/classCallCheck\");\n\nvar _createClass = require(\"/Users/safahi/Downloads/interface-4.30.1/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/createClass\");\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function get() {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n      d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) {\n    if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  }\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) {\n    if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  }\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WalletLinkRelay = void 0;\n\nvar bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\n\nvar rxjs_1 = require(\"rxjs\");\n\nvar operators_1 = require(\"rxjs/operators\");\n\nvar WalletLinkAnalytics_1 = require(\"../connection/WalletLinkAnalytics\");\n\nvar WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\n\nvar init_1 = require(\"../init\");\n\nvar util_1 = require(\"../util\");\n\nvar aes256gcm = __importStar(require(\"./aes256gcm\"));\n\nvar Session_1 = require(\"./Session\");\n\nvar WalletLinkRelayAbstract_1 = require(\"./WalletLinkRelayAbstract\");\n\nvar Web3Method_1 = require(\"./Web3Method\");\n\nvar Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\n\nvar Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\n\nvar Web3Response_1 = require(\"./Web3Response\");\n\nvar Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\n\nvar WalletLinkRelay = /*#__PURE__*/function () {\n  function WalletLinkRelay(options) {\n    var _this = this;\n\n    _classCallCheck(this, WalletLinkRelay);\n\n    this.accountsCallback = null;\n    this.chainIdCallback = null;\n    this.jsonRpcUrlCallback = null;\n    this.appName = \"\";\n    this.appLogoUrl = null;\n    this.subscriptions = new rxjs_1.Subscription();\n    this.walletLinkUrl = options.walletLinkUrl;\n    this.storage = options.storage;\n    this._session = Session_1.Session.load(options.storage) || new Session_1.Session(options.storage).save();\n    this.relayEventManager = options.relayEventManager;\n    this.walletLinkAnalytics = options.walletLinkAnalytics ? options.walletLinkAnalytics : new WalletLinkAnalytics_1.WalletLinkAnalytics();\n    this.connection = new WalletLinkConnection_1.WalletLinkConnection(this._session.id, this._session.key, this.walletLinkUrl, this.walletLinkAnalytics);\n    this.subscriptions.add(this.connection.incomingEvent$.pipe(operators_1.filter(function (m) {\n      return m.event === \"Web3Response\";\n    })).subscribe({\n      next: this.handleIncomingEvent\n    }));\n    this.subscriptions.add(this.connection.linked$.pipe(operators_1.skip(1), operators_1.tap(function (linked) {\n      var _a;\n\n      _this.isLinked = linked;\n\n      var cachedAddresses = _this.storage.getItem(WalletLinkRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n\n      if (cachedAddresses) {\n        var addresses = cachedAddresses.split(\" \");\n\n        if (addresses[0] !== \"\" && !linked) {\n          var sessionIdHash = Session_1.Session.hash(_this._session.id);\n          (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.UNLINKED_ERROR_STATE, {\n            sessionIdHash: sessionIdHash\n          });\n        }\n      }\n    })).subscribe()); // if session is marked destroyed, reset and reload\n\n    this.subscriptions.add(this.connection.sessionConfig$.pipe(operators_1.filter(function (c) {\n      return !!c.metadata && c.metadata.__destroyed === \"1\";\n    })).subscribe(function () {\n      var _a;\n\n      var alreadyDestroyed = _this.connection.isDestroyed;\n      (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.METADATA_DESTROYED, {\n        alreadyDestroyed: alreadyDestroyed,\n        sessionIdHash: Session_1.Session.hash(_this._session.id)\n      });\n      return _this.resetAndReload();\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe(operators_1.filter(function (c) {\n      return c.metadata && c.metadata.WalletUsername !== undefined;\n    })).pipe(operators_1.mergeMap(function (c) {\n      return aes256gcm.decrypt(c.metadata.WalletUsername, _this._session.secret);\n    })).subscribe({\n      next: function next(walletUsername) {\n        _this.storage.setItem(WalletLinkRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n      },\n      error: function error() {\n        var _a;\n\n        (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: 'Had error decrypting',\n          value: 'username'\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe(operators_1.filter(function (c) {\n      return c.metadata && c.metadata.ChainId !== undefined;\n    })).pipe(operators_1.mergeMap(function (c) {\n      return aes256gcm.decrypt(c.metadata.ChainId, _this._session.secret);\n    })).pipe(operators_1.distinctUntilChanged()).subscribe({\n      next: function next(chainId) {\n        if (_this.chainIdCallback) {\n          _this.chainIdCallback(chainId);\n        }\n      },\n      error: function error() {\n        var _a;\n\n        (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: 'Had error decrypting',\n          value: 'chainId'\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe(operators_1.filter(function (c) {\n      return c.metadata && c.metadata.JsonRpcUrl !== undefined;\n    })).pipe(operators_1.mergeMap(function (c) {\n      return aes256gcm.decrypt(c.metadata.JsonRpcUrl, _this._session.secret);\n    })).pipe(operators_1.distinctUntilChanged()).subscribe({\n      next: function next(jsonRpcURl) {\n        if (_this.jsonRpcUrlCallback) {\n          _this.jsonRpcUrlCallback(jsonRpcURl);\n        }\n      },\n      error: function error() {\n        var _a;\n\n        (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: 'Had error decrypting',\n          value: 'jsonRpcUrl'\n        });\n      }\n    }));\n    this.subscriptions.add(this.connection.sessionConfig$.pipe(operators_1.filter(function (c) {\n      return c.metadata && c.metadata.EthereumAddress !== undefined;\n    })).pipe(operators_1.mergeMap(function (c) {\n      return aes256gcm.decrypt(c.metadata.EthereumAddress, _this._session.secret);\n    })).subscribe({\n      next: function next(selectedAddress) {\n        if (_this.accountsCallback) {\n          _this.accountsCallback([selectedAddress]);\n        }\n\n        if (WalletLinkRelay.accountRequestCallbackIds.size > 0) {\n          // We get the ethereum address from the metadata.  If for whatever\n          // reason we don't get a response via an explicit web3 message\n          // we can still fulfill the eip1102 request.\n          Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(function (id) {\n            var message = Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: Web3Response_1.RequestEthereumAccountsResponse([selectedAddress])\n            });\n\n            _this.invokeCallback(Object.assign(Object.assign({}, message), {\n              id: id\n            }));\n          });\n          WalletLinkRelay.accountRequestCallbackIds.clear();\n        }\n      },\n      error: function error() {\n        var _a;\n\n        (_a = _this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n          message: 'Had error decrypting',\n          value: 'selectedAddress'\n        });\n      }\n    }));\n    this.ui = options.walletLinkUIConstructor({\n      walletLinkUrl: options.walletLinkUrl,\n      version: options.version,\n      darkMode: options.darkMode,\n      session: this._session,\n      connected$: this.connection.connected$\n    });\n    this.connection.connect();\n  }\n\n  _createClass(WalletLinkRelay, [{\n    key: \"attachUI\",\n    value: function attachUI() {\n      this.ui.attach();\n    }\n  }, {\n    key: \"resetAndReload\",\n    value: function resetAndReload() {\n      var _this2 = this;\n\n      this.connection.setSessionMetadata(\"__destroyed\", \"1\").pipe(operators_1.timeout(1000), operators_1.catchError(function (_) {\n        return rxjs_1.of(null);\n      })).subscribe(function (_) {\n        var _a, _b;\n\n        try {\n          _this2.subscriptions.unsubscribe();\n        } catch (err) {\n          (_a = _this2.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n            message: \"Had error unsubscribing\"\n          });\n        }\n\n        (_b = _this2.walletLinkAnalytics) === null || _b === void 0 ? void 0 : _b.sendEvent(init_1.EVENTS.SESSION_STATE_CHANGE, {\n          method: \"relay::resetAndReload\",\n          sessionMetadataChange: \"__destroyed, 1\",\n          sessionIdHash: Session_1.Session.hash(_this2._session.id)\n        });\n\n        _this2.connection.destroy();\n\n        _this2.storage.clear();\n\n        _this2.ui.reloadUI();\n      }, function (err) {\n        var _a;\n\n        (_a = _this2.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.FAILURE, {\n          method: \"relay::resetAndReload\",\n          message: \"faled to reset and relod with \".concat(err),\n          sessionIdHash: Session_1.Session.hash(_this2._session.id)\n        });\n      });\n    }\n  }, {\n    key: \"setAppInfo\",\n    value: function setAppInfo(appName, appLogoUrl) {\n      this.appName = appName;\n      this.appLogoUrl = appLogoUrl;\n    }\n  }, {\n    key: \"getStorageItem\",\n    value: function getStorageItem(key) {\n      return this.storage.getItem(key);\n    }\n  }, {\n    key: \"session\",\n    get: function get() {\n      return this._session;\n    }\n  }, {\n    key: \"setStorageItem\",\n    value: function setStorageItem(key, value) {\n      this.storage.setItem(key, value);\n    }\n  }, {\n    key: \"requestEthereumAccounts\",\n    value: function requestEthereumAccounts() {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.requestEthereumAccounts,\n        params: {\n          appName: this.appName,\n          appLogoUrl: this.appLogoUrl || null\n        }\n      });\n    }\n  }, {\n    key: \"signEthereumMessage\",\n    value: function signEthereumMessage(message, address, addPrefix, typedDataJson) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumMessage,\n        params: {\n          message: util_1.hexStringFromBuffer(message, true),\n          address: address,\n          addPrefix: addPrefix,\n          typedDataJson: typedDataJson || null\n        }\n      });\n    }\n  }, {\n    key: \"ethereumAddressFromSignedMessage\",\n    value: function ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n        params: {\n          message: util_1.hexStringFromBuffer(message, true),\n          signature: util_1.hexStringFromBuffer(signature, true),\n          addPrefix: addPrefix\n        }\n      });\n    }\n  }, {\n    key: \"signEthereumTransaction\",\n    value: function signEthereumTransaction(params) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumTransaction,\n        params: {\n          fromAddress: params.fromAddress,\n          toAddress: params.toAddress,\n          weiValue: util_1.bigIntStringFromBN(params.weiValue),\n          data: util_1.hexStringFromBuffer(params.data, true),\n          nonce: params.nonce,\n          gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          maxFeePerGas: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          maxPriorityFeePerGas: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n          chainId: params.chainId,\n          shouldSubmit: false\n        }\n      });\n    }\n  }, {\n    key: \"signAndSubmitEthereumTransaction\",\n    value: function signAndSubmitEthereumTransaction(params) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.signEthereumTransaction,\n        params: {\n          fromAddress: params.fromAddress,\n          toAddress: params.toAddress,\n          weiValue: util_1.bigIntStringFromBN(params.weiValue),\n          data: util_1.hexStringFromBuffer(params.data, true),\n          nonce: params.nonce,\n          gasPriceInWei: params.gasPriceInWei ? util_1.bigIntStringFromBN(params.gasPriceInWei) : null,\n          maxFeePerGas: params.maxFeePerGas ? util_1.bigIntStringFromBN(params.maxFeePerGas) : null,\n          maxPriorityFeePerGas: params.maxPriorityFeePerGas ? util_1.bigIntStringFromBN(params.maxPriorityFeePerGas) : null,\n          gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n          chainId: params.chainId,\n          shouldSubmit: true\n        }\n      });\n    }\n  }, {\n    key: \"submitEthereumTransaction\",\n    value: function submitEthereumTransaction(signedTransaction, chainId) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.submitEthereumTransaction,\n        params: {\n          signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n          chainId: chainId\n        }\n      });\n    }\n  }, {\n    key: \"scanQRCode\",\n    value: function scanQRCode(regExp) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.scanQRCode,\n        params: {\n          regExp: regExp\n        }\n      });\n    }\n  }, {\n    key: \"arbitraryRequest\",\n    value: function arbitraryRequest(data) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.arbitrary,\n        params: {\n          data: data\n        }\n      });\n    }\n  }, {\n    key: \"addEthereumChain\",\n    value: function addEthereumChain(chainId, blockExplorerUrls, chainName, iconUrls, nativeCurrency) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.addEthereumChain,\n        params: {\n          chainId: chainId,\n          blockExplorerUrls: blockExplorerUrls,\n          chainName: chainName,\n          iconUrls: iconUrls,\n          nativeCurrency: nativeCurrency\n        }\n      });\n    }\n  }, {\n    key: \"sendRequest\",\n    value: function sendRequest(request) {\n      var _this3 = this;\n\n      var hideSnackbarItem = null;\n      var id = util_1.randomBytesHex(8);\n\n      var cancel = function cancel() {\n        _this3.publishWeb3RequestCanceledEvent(id);\n\n        _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n          id: id,\n          response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n        }));\n\n        hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n      };\n\n      var promise = new Promise(function (resolve, reject) {\n        var _a;\n\n        var isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n        var isSwitchEthereumChain = request.method === Web3Method_1.Web3Method.switchEthereumChain;\n\n        if (isRequestAccounts) {\n          var userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n\n          if (userAgent && /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n            window.location.href = \"https://go.cb-w.com/xoXnYwQimhb?cb_url=\".concat(window.location.href);\n            return;\n          }\n\n          if (_this3.ui.inlineAccountsResponse()) {\n            var onAccounts = function onAccounts(accounts) {\n              _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                id: id,\n                response: Web3Response_1.RequestEthereumAccountsResponse(accounts)\n              }));\n            };\n\n            _this3.ui.requestEthereumAccounts({\n              onCancel: cancel,\n              onAccounts: onAccounts\n            });\n          } else {\n            _this3.ui.requestEthereumAccounts({\n              onCancel: cancel\n            });\n          }\n\n          WalletLinkRelay.accountRequestCallbackIds.add(id);\n        } else if (request.method === Web3Method_1.Web3Method.switchEthereumChain || request.method === Web3Method_1.Web3Method.addEthereumChain) {\n          var _cancel = function _cancel() {\n            _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: Web3Response_1.SwitchEthereumChainResponse(false)\n            }));\n          };\n\n          var approve = function approve() {\n            _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: Web3Response_1.SwitchEthereumChainResponse(true)\n            }));\n          };\n\n          _this3.ui.switchEthereumChain({\n            onCancel: _cancel,\n            onApprove: approve,\n            chainId: request.params.chainId\n          });\n\n          if (!_this3.ui.inlineSwitchEthereumChain()) {\n            hideSnackbarItem = _this3.ui.showConnecting({\n              onCancel: _cancel,\n              onResetConnection: _this3.resetAndReload\n            });\n          }\n        } else if (_this3.ui.isStandalone()) {\n          var onCancel = function onCancel() {\n            _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n            }));\n          };\n\n          var onSuccess = function onSuccess(response) {\n            _this3.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n              id: id,\n              response: response\n            }));\n          };\n\n          switch (request.method) {\n            case Web3Method_1.Web3Method.signEthereumMessage:\n              _this3.ui.signEthereumMessage({\n                request: request,\n                onSuccess: onSuccess,\n                onCancel: onCancel\n              });\n\n              break;\n\n            case Web3Method_1.Web3Method.signEthereumTransaction:\n              _this3.ui.signEthereumTransaction({\n                request: request,\n                onSuccess: onSuccess,\n                onCancel: onCancel\n              });\n\n              break;\n\n            case Web3Method_1.Web3Method.submitEthereumTransaction:\n              _this3.ui.submitEthereumTransaction({\n                request: request,\n                onSuccess: onSuccess,\n                onCancel: onCancel\n              });\n\n              break;\n\n            case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n              _this3.ui.ethereumAddressFromSignedMessage({\n                request: request,\n                onSuccess: onSuccess\n              });\n\n              break;\n\n            default:\n              onCancel();\n              break;\n          }\n        } else {\n          hideSnackbarItem = _this3.ui.showConnecting({\n            onCancel: cancel,\n            onResetConnection: _this3.resetAndReload\n          });\n        }\n\n        _this3.relayEventManager.callbacks.set(id, function (response) {\n          _this3.ui.hideRequestEthereumAccounts();\n\n          hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n\n          if (response.errorMessage) {\n            return reject(new Error(response.errorMessage));\n          }\n\n          resolve(response);\n        });\n\n        if (isRequestAccounts && _this3.ui.inlineAccountsResponse() || isSwitchEthereumChain && _this3.ui.inlineSwitchEthereumChain() || _this3.ui.isStandalone()) {\n          return;\n        }\n\n        _this3.publishWeb3RequestEvent(id, request);\n      });\n      return {\n        promise: promise,\n        cancel: cancel\n      };\n    }\n  }, {\n    key: \"setConnectDisabled\",\n    value: function setConnectDisabled(disabled) {\n      this.ui.setConnectDisabled(disabled);\n    }\n  }, {\n    key: \"setAccountsCallback\",\n    value: function setAccountsCallback(accountsCallback) {\n      this.accountsCallback = accountsCallback;\n    }\n  }, {\n    key: \"setChainIdCallback\",\n    value: function setChainIdCallback(chainIdCallback) {\n      this.chainIdCallback = chainIdCallback;\n    }\n  }, {\n    key: \"setJsonRpcUrlCallback\",\n    value: function setJsonRpcUrlCallback(jsonRpcUrlCallback) {\n      this.jsonRpcUrlCallback = jsonRpcUrlCallback;\n    }\n  }, {\n    key: \"publishWeb3RequestEvent\",\n    value: function publishWeb3RequestEvent(id, request) {\n      var _this4 = this;\n\n      var message = Web3RequestMessage_1.Web3RequestMessage({\n        id: id,\n        request: request\n      });\n      this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n        error: function error(err) {\n          _this4.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n            id: message.id,\n            response: {\n              method: message.request.method,\n              errorMessage: err.message\n            }\n          }));\n        }\n      }));\n    }\n  }, {\n    key: \"publishWeb3RequestCanceledEvent\",\n    value: function publishWeb3RequestCanceledEvent(id) {\n      var message = Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id);\n      this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n    }\n  }, {\n    key: \"publishEvent\",\n    value: function publishEvent(event, message, callWebhook) {\n      var _this5 = this;\n\n      var secret = this.session.secret;\n      return new rxjs_1.Observable(function (subscriber) {\n        aes256gcm.encrypt(JSON.stringify(Object.assign(Object.assign({}, message), {\n          origin: location.origin\n        })), secret).then(function (encrypted) {\n          subscriber.next(encrypted);\n          subscriber.complete();\n        });\n      }).pipe(operators_1.mergeMap(function (encrypted) {\n        return _this5.connection.publishEvent(event, encrypted, callWebhook);\n      }));\n    }\n  }, {\n    key: \"handleIncomingEvent\",\n    value: function handleIncomingEvent(event) {\n      var _this6 = this;\n\n      try {\n        this.subscriptions.add(aes256gcm.decrypt(event.data, this.session.secret).pipe(operators_1.map(function (c) {\n          return JSON.parse(c);\n        })).subscribe({\n          next: function next(json) {\n            var message = Web3ResponseMessage_1.isWeb3ResponseMessage(json) ? json : null;\n\n            if (!message) {\n              return;\n            }\n\n            _this6.handleWeb3ResponseMessage(message);\n          },\n          error: function error() {\n            var _a;\n\n            (_a = _this6.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n              message: 'Had error decrypting',\n              value: 'incomingEvent'\n            });\n          }\n        }));\n      } catch (_a) {\n        return;\n      }\n    }\n  }, {\n    key: \"handleWeb3ResponseMessage\",\n    value: function handleWeb3ResponseMessage(message) {\n      var _this7 = this;\n\n      var response = message.response;\n\n      if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n        Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(function (id) {\n          return _this7.invokeCallback(Object.assign(Object.assign({}, message), {\n            id: id\n          }));\n        });\n        WalletLinkRelay.accountRequestCallbackIds.clear();\n        return;\n      }\n\n      this.invokeCallback(message);\n    }\n  }, {\n    key: \"invokeCallback\",\n    value: function invokeCallback(message) {\n      var callback = this.relayEventManager.callbacks.get(message.id);\n\n      if (callback) {\n        callback(message.response);\n        this.relayEventManager.callbacks.delete(message.id);\n      }\n    }\n  }, {\n    key: \"switchEthereumChain\",\n    value: function switchEthereumChain(chainId) {\n      return this.sendRequest({\n        method: Web3Method_1.Web3Method.switchEthereumChain,\n        params: {\n          chainId: chainId\n        }\n      });\n    }\n  }]);\n\n  return WalletLinkRelay;\n}();\n\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"resetAndReload\", null);\n\n__decorate([bind_decorator_1.default], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\n\nexports.WalletLinkRelay = WalletLinkRelay;","map":{"version":3,"sources":["/Users/safahi/Downloads/interface-4.30.1/node_modules/walletlink/dist/relay/WalletLinkRelay.js"],"names":["__createBinding","Object","create","o","m","k","k2","undefined","defineProperty","enumerable","get","__setModuleDefault","v","value","__decorate","decorators","target","key","desc","c","arguments","length","r","getOwnPropertyDescriptor","d","Reflect","decorate","i","__importStar","mod","__esModule","result","prototype","hasOwnProperty","call","__importDefault","exports","WalletLinkRelay","bind_decorator_1","require","rxjs_1","operators_1","WalletLinkAnalytics_1","WalletLinkConnection_1","init_1","util_1","aes256gcm","Session_1","WalletLinkRelayAbstract_1","Web3Method_1","Web3RequestCanceledMessage_1","Web3RequestMessage_1","Web3Response_1","Web3ResponseMessage_1","options","accountsCallback","chainIdCallback","jsonRpcUrlCallback","appName","appLogoUrl","subscriptions","Subscription","walletLinkUrl","storage","_session","Session","load","save","relayEventManager","walletLinkAnalytics","WalletLinkAnalytics","connection","WalletLinkConnection","id","add","incomingEvent$","pipe","filter","event","subscribe","next","handleIncomingEvent","linked$","skip","tap","linked","_a","isLinked","cachedAddresses","getItem","LOCAL_STORAGE_ADDRESSES_KEY","addresses","split","sessionIdHash","hash","sendEvent","EVENTS","UNLINKED_ERROR_STATE","sessionConfig$","metadata","__destroyed","alreadyDestroyed","isDestroyed","METADATA_DESTROYED","resetAndReload","WalletUsername","mergeMap","decrypt","secret","walletUsername","setItem","WALLET_USER_NAME_KEY","error","GENERAL_ERROR","message","ChainId","distinctUntilChanged","chainId","JsonRpcUrl","jsonRpcURl","EthereumAddress","selectedAddress","accountRequestCallbackIds","size","Array","from","values","forEach","Web3ResponseMessage","response","RequestEthereumAccountsResponse","invokeCallback","assign","clear","ui","walletLinkUIConstructor","version","darkMode","session","connected$","connect","attach","setSessionMetadata","timeout","catchError","_","of","_b","unsubscribe","err","SESSION_STATE_CHANGE","method","sessionMetadataChange","destroy","reloadUI","FAILURE","sendRequest","Web3Method","requestEthereumAccounts","params","address","addPrefix","typedDataJson","signEthereumMessage","hexStringFromBuffer","signature","ethereumAddressFromSignedMessage","signEthereumTransaction","fromAddress","toAddress","weiValue","bigIntStringFromBN","data","nonce","gasPriceInWei","maxFeePerGas","maxPriorityFeePerGas","gasLimit","shouldSubmit","signedTransaction","submitEthereumTransaction","regExp","scanQRCode","arbitrary","blockExplorerUrls","chainName","iconUrls","nativeCurrency","addEthereumChain","request","hideSnackbarItem","randomBytesHex","cancel","publishWeb3RequestCanceledEvent","handleWeb3ResponseMessage","ErrorResponse","promise","Promise","resolve","reject","isRequestAccounts","isSwitchEthereumChain","switchEthereumChain","userAgent","window","navigator","test","location","href","inlineAccountsResponse","onAccounts","accounts","onCancel","SwitchEthereumChainResponse","approve","onApprove","inlineSwitchEthereumChain","showConnecting","onResetConnection","isStandalone","onSuccess","callbacks","set","hideRequestEthereumAccounts","errorMessage","Error","publishWeb3RequestEvent","disabled","setConnectDisabled","Web3RequestMessage","publishEvent","Web3RequestCanceledMessage","callWebhook","Observable","subscriber","encrypt","JSON","stringify","origin","then","encrypted","complete","map","parse","json","isWeb3ResponseMessage","isRequestEthereumAccountsResponse","callback","delete","Set","default"],"mappings":"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","sourcesContent":["\"use strict\";\n// Copyright (c) 2018-2020 WalletLink.org <https://www.walletlink.org/>\n// Copyright (c) 2018-2020 Coinbase, Inc. <https://www.coinbase.com/>\n// Licensed under the Apache License, version 2.0\nvar __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\n}) : (function(o, m, k, k2) {\n    if (k2 === undefined) k2 = k;\n    o[k2] = m[k];\n}));\nvar __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\n}) : function(o, v) {\n    o[\"default\"] = v;\n});\nvar __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __importStar = (this && this.__importStar) || function (mod) {\n    if (mod && mod.__esModule) return mod;\n    var result = {};\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n    __setModuleDefault(result, mod);\n    return result;\n};\nvar __importDefault = (this && this.__importDefault) || function (mod) {\n    return (mod && mod.__esModule) ? mod : { \"default\": mod };\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.WalletLinkRelay = void 0;\nconst bind_decorator_1 = __importDefault(require(\"bind-decorator\"));\nconst rxjs_1 = require(\"rxjs\");\nconst operators_1 = require(\"rxjs/operators\");\nconst WalletLinkAnalytics_1 = require(\"../connection/WalletLinkAnalytics\");\nconst WalletLinkConnection_1 = require(\"../connection/WalletLinkConnection\");\nconst init_1 = require(\"../init\");\nconst util_1 = require(\"../util\");\nconst aes256gcm = __importStar(require(\"./aes256gcm\"));\nconst Session_1 = require(\"./Session\");\nconst WalletLinkRelayAbstract_1 = require(\"./WalletLinkRelayAbstract\");\nconst Web3Method_1 = require(\"./Web3Method\");\nconst Web3RequestCanceledMessage_1 = require(\"./Web3RequestCanceledMessage\");\nconst Web3RequestMessage_1 = require(\"./Web3RequestMessage\");\nconst Web3Response_1 = require(\"./Web3Response\");\nconst Web3ResponseMessage_1 = require(\"./Web3ResponseMessage\");\nclass WalletLinkRelay {\n    constructor(options) {\n        this.accountsCallback = null;\n        this.chainIdCallback = null;\n        this.jsonRpcUrlCallback = null;\n        this.appName = \"\";\n        this.appLogoUrl = null;\n        this.subscriptions = new rxjs_1.Subscription();\n        this.walletLinkUrl = options.walletLinkUrl;\n        this.storage = options.storage;\n        this._session =\n            Session_1.Session.load(options.storage) || new Session_1.Session(options.storage).save();\n        this.relayEventManager = options.relayEventManager;\n        this.walletLinkAnalytics = options.walletLinkAnalytics\n            ? options.walletLinkAnalytics\n            : new WalletLinkAnalytics_1.WalletLinkAnalytics();\n        this.connection = new WalletLinkConnection_1.WalletLinkConnection(this._session.id, this._session.key, this.walletLinkUrl, this.walletLinkAnalytics);\n        this.subscriptions.add(this.connection.incomingEvent$\n            .pipe(operators_1.filter(m => m.event === \"Web3Response\"))\n            .subscribe({ next: this.handleIncomingEvent }));\n        this.subscriptions.add(this.connection.linked$\n            .pipe(operators_1.skip(1), operators_1.tap((linked) => {\n            var _a;\n            this.isLinked = linked;\n            const cachedAddresses = this.storage.getItem(WalletLinkRelayAbstract_1.LOCAL_STORAGE_ADDRESSES_KEY);\n            if (cachedAddresses) {\n                const addresses = cachedAddresses.split(\" \");\n                if (addresses[0] !== \"\" && !linked) {\n                    const sessionIdHash = Session_1.Session.hash(this._session.id);\n                    (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.UNLINKED_ERROR_STATE, { sessionIdHash });\n                }\n            }\n        }))\n            .subscribe());\n        // if session is marked destroyed, reset and reload\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => !!c.metadata && c.metadata.__destroyed === \"1\"))\n            .subscribe(() => {\n            var _a;\n            const alreadyDestroyed = this.connection.isDestroyed;\n            (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.METADATA_DESTROYED, {\n                alreadyDestroyed,\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n            return this.resetAndReload();\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => c.metadata && c.metadata.WalletUsername !== undefined))\n            .pipe(operators_1.mergeMap(c => aes256gcm.decrypt(c.metadata.WalletUsername, this._session.secret)))\n            .subscribe({\n            next: walletUsername => {\n                this.storage.setItem(WalletLinkRelayAbstract_1.WALLET_USER_NAME_KEY, walletUsername);\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, { message: 'Had error decrypting', value: 'username' });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => c.metadata && c.metadata.ChainId !== undefined))\n            .pipe(operators_1.mergeMap(c => aes256gcm.decrypt(c.metadata.ChainId, this._session.secret)))\n            .pipe(operators_1.distinctUntilChanged())\n            .subscribe({\n            next: chainId => {\n                if (this.chainIdCallback) {\n                    this.chainIdCallback(chainId);\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, { message: 'Had error decrypting', value: 'chainId' });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => c.metadata && c.metadata.JsonRpcUrl !== undefined))\n            .pipe(operators_1.mergeMap(c => aes256gcm.decrypt(c.metadata.JsonRpcUrl, this._session.secret)))\n            .pipe(operators_1.distinctUntilChanged())\n            .subscribe({\n            next: jsonRpcURl => {\n                if (this.jsonRpcUrlCallback) {\n                    this.jsonRpcUrlCallback(jsonRpcURl);\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, { message: 'Had error decrypting', value: 'jsonRpcUrl' });\n            }\n        }));\n        this.subscriptions.add(this.connection.sessionConfig$\n            .pipe(operators_1.filter(c => c.metadata && c.metadata.EthereumAddress !== undefined))\n            .pipe(operators_1.mergeMap(c => aes256gcm.decrypt(c.metadata.EthereumAddress, this._session.secret)))\n            .subscribe({\n            next: selectedAddress => {\n                if (this.accountsCallback) {\n                    this.accountsCallback([selectedAddress]);\n                }\n                if (WalletLinkRelay.accountRequestCallbackIds.size > 0) {\n                    // We get the ethereum address from the metadata.  If for whatever\n                    // reason we don't get a response via an explicit web3 message\n                    // we can still fulfill the eip1102 request.\n                    Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => {\n                        const message = Web3ResponseMessage_1.Web3ResponseMessage({\n                            id,\n                            response: Web3Response_1.RequestEthereumAccountsResponse([\n                                selectedAddress\n                            ])\n                        });\n                        this.invokeCallback(Object.assign(Object.assign({}, message), { id }));\n                    });\n                    WalletLinkRelay.accountRequestCallbackIds.clear();\n                }\n            },\n            error: () => {\n                var _a;\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, { message: 'Had error decrypting', value: 'selectedAddress' });\n            }\n        }));\n        this.ui = options.walletLinkUIConstructor({\n            walletLinkUrl: options.walletLinkUrl,\n            version: options.version,\n            darkMode: options.darkMode,\n            session: this._session,\n            connected$: this.connection.connected$\n        });\n        this.connection.connect();\n    }\n    attachUI() {\n        this.ui.attach();\n    }\n    resetAndReload() {\n        this.connection\n            .setSessionMetadata(\"__destroyed\", \"1\")\n            .pipe(operators_1.timeout(1000), operators_1.catchError(_ => rxjs_1.of(null)))\n            .subscribe(_ => {\n            var _a, _b;\n            try {\n                this.subscriptions.unsubscribe();\n            }\n            catch (err) {\n                (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, {\n                    message: \"Had error unsubscribing\"\n                });\n            }\n            (_b = this.walletLinkAnalytics) === null || _b === void 0 ? void 0 : _b.sendEvent(init_1.EVENTS.SESSION_STATE_CHANGE, {\n                method: \"relay::resetAndReload\",\n                sessionMetadataChange: \"__destroyed, 1\",\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n            this.connection.destroy();\n            this.storage.clear();\n            this.ui.reloadUI();\n        }, err => {\n            var _a;\n            (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.FAILURE, {\n                method: \"relay::resetAndReload\",\n                message: `faled to reset and relod with ${err}`,\n                sessionIdHash: Session_1.Session.hash(this._session.id)\n            });\n        });\n    }\n    setAppInfo(appName, appLogoUrl) {\n        this.appName = appName;\n        this.appLogoUrl = appLogoUrl;\n    }\n    getStorageItem(key) {\n        return this.storage.getItem(key);\n    }\n    get session() {\n        return this._session;\n    }\n    setStorageItem(key, value) {\n        this.storage.setItem(key, value);\n    }\n    requestEthereumAccounts() {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.requestEthereumAccounts,\n            params: {\n                appName: this.appName,\n                appLogoUrl: this.appLogoUrl || null\n            }\n        });\n    }\n    signEthereumMessage(message, address, addPrefix, typedDataJson) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                address,\n                addPrefix,\n                typedDataJson: typedDataJson || null\n            }\n        });\n    }\n    ethereumAddressFromSignedMessage(message, signature, addPrefix) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.ethereumAddressFromSignedMessage,\n            params: {\n                message: util_1.hexStringFromBuffer(message, true),\n                signature: util_1.hexStringFromBuffer(signature, true),\n                addPrefix\n            }\n        });\n    }\n    signEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                maxPriorityFeePerGas: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: false\n            }\n        });\n    }\n    signAndSubmitEthereumTransaction(params) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.signEthereumTransaction,\n            params: {\n                fromAddress: params.fromAddress,\n                toAddress: params.toAddress,\n                weiValue: util_1.bigIntStringFromBN(params.weiValue),\n                data: util_1.hexStringFromBuffer(params.data, true),\n                nonce: params.nonce,\n                gasPriceInWei: params.gasPriceInWei\n                    ? util_1.bigIntStringFromBN(params.gasPriceInWei)\n                    : null,\n                maxFeePerGas: params.maxFeePerGas\n                    ? util_1.bigIntStringFromBN(params.maxFeePerGas)\n                    : null,\n                maxPriorityFeePerGas: params.maxPriorityFeePerGas\n                    ? util_1.bigIntStringFromBN(params.maxPriorityFeePerGas)\n                    : null,\n                gasLimit: params.gasLimit ? util_1.bigIntStringFromBN(params.gasLimit) : null,\n                chainId: params.chainId,\n                shouldSubmit: true\n            }\n        });\n    }\n    submitEthereumTransaction(signedTransaction, chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.submitEthereumTransaction,\n            params: {\n                signedTransaction: util_1.hexStringFromBuffer(signedTransaction, true),\n                chainId\n            }\n        });\n    }\n    scanQRCode(regExp) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.scanQRCode,\n            params: { regExp }\n        });\n    }\n    arbitraryRequest(data) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.arbitrary,\n            params: { data }\n        });\n    }\n    addEthereumChain(chainId, blockExplorerUrls, chainName, iconUrls, nativeCurrency) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.addEthereumChain,\n            params: {\n                chainId,\n                blockExplorerUrls,\n                chainName,\n                iconUrls,\n                nativeCurrency\n            }\n        });\n    }\n    sendRequest(request) {\n        let hideSnackbarItem = null;\n        const id = util_1.randomBytesHex(8);\n        const cancel = () => {\n            this.publishWeb3RequestCanceledEvent(id);\n            this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                id,\n                response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n            }));\n            hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n        };\n        const promise = new Promise((resolve, reject) => {\n            var _a;\n            const isRequestAccounts = request.method === Web3Method_1.Web3Method.requestEthereumAccounts;\n            const isSwitchEthereumChain = request.method === Web3Method_1.Web3Method.switchEthereumChain;\n            if (isRequestAccounts) {\n                const userAgent = ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.userAgent) || null;\n                if (userAgent &&\n                    /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent)) {\n                    window.location.href = `https://go.cb-w.com/xoXnYwQimhb?cb_url=${window.location.href}`;\n                    return;\n                }\n                if (this.ui.inlineAccountsResponse()) {\n                    const onAccounts = (accounts) => {\n                        this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                            id,\n                            response: Web3Response_1.RequestEthereumAccountsResponse(accounts)\n                        }));\n                    };\n                    this.ui.requestEthereumAccounts({\n                        onCancel: cancel,\n                        onAccounts\n                    });\n                }\n                else {\n                    this.ui.requestEthereumAccounts({\n                        onCancel: cancel\n                    });\n                }\n                WalletLinkRelay.accountRequestCallbackIds.add(id);\n            }\n            else if (request.method === Web3Method_1.Web3Method.switchEthereumChain ||\n                request.method === Web3Method_1.Web3Method.addEthereumChain) {\n                const cancel = () => {\n                    this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                        id,\n                        response: Web3Response_1.SwitchEthereumChainResponse(false)\n                    }));\n                };\n                const approve = () => {\n                    this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                        id,\n                        response: Web3Response_1.SwitchEthereumChainResponse(true)\n                    }));\n                };\n                this.ui.switchEthereumChain({\n                    onCancel: cancel,\n                    onApprove: approve,\n                    chainId: request.params.chainId\n                });\n                if (!this.ui.inlineSwitchEthereumChain()) {\n                    hideSnackbarItem = this.ui.showConnecting({\n                        onCancel: cancel,\n                        onResetConnection: this.resetAndReload\n                    });\n                }\n            }\n            else if (this.ui.isStandalone()) {\n                const onCancel = () => {\n                    this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                        id,\n                        response: Web3Response_1.ErrorResponse(request.method, \"User rejected request\")\n                    }));\n                };\n                const onSuccess = (response) => {\n                    this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                        id,\n                        response: response\n                    }));\n                };\n                switch (request.method) {\n                    case Web3Method_1.Web3Method.signEthereumMessage:\n                        this.ui.signEthereumMessage({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.signEthereumTransaction:\n                        this.ui.signEthereumTransaction({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.submitEthereumTransaction:\n                        this.ui.submitEthereumTransaction({\n                            request: request,\n                            onSuccess,\n                            onCancel\n                        });\n                        break;\n                    case Web3Method_1.Web3Method.ethereumAddressFromSignedMessage:\n                        this.ui.ethereumAddressFromSignedMessage({\n                            request: request,\n                            onSuccess\n                        });\n                        break;\n                    default:\n                        onCancel();\n                        break;\n                }\n            }\n            else {\n                hideSnackbarItem = this.ui.showConnecting({\n                    onCancel: cancel,\n                    onResetConnection: this.resetAndReload\n                });\n            }\n            this.relayEventManager.callbacks.set(id, response => {\n                this.ui.hideRequestEthereumAccounts();\n                hideSnackbarItem === null || hideSnackbarItem === void 0 ? void 0 : hideSnackbarItem();\n                if (response.errorMessage) {\n                    return reject(new Error(response.errorMessage));\n                }\n                resolve(response);\n            });\n            if ((isRequestAccounts && this.ui.inlineAccountsResponse()) ||\n                (isSwitchEthereumChain && this.ui.inlineSwitchEthereumChain()) ||\n                this.ui.isStandalone()) {\n                return;\n            }\n            this.publishWeb3RequestEvent(id, request);\n        });\n        return { promise, cancel };\n    }\n    setConnectDisabled(disabled) {\n        this.ui.setConnectDisabled(disabled);\n    }\n    setAccountsCallback(accountsCallback) {\n        this.accountsCallback = accountsCallback;\n    }\n    setChainIdCallback(chainIdCallback) {\n        this.chainIdCallback = chainIdCallback;\n    }\n    setJsonRpcUrlCallback(jsonRpcUrlCallback) {\n        this.jsonRpcUrlCallback = jsonRpcUrlCallback;\n    }\n    publishWeb3RequestEvent(id, request) {\n        const message = Web3RequestMessage_1.Web3RequestMessage({ id, request });\n        this.subscriptions.add(this.publishEvent(\"Web3Request\", message, true).subscribe({\n            error: err => {\n                this.handleWeb3ResponseMessage(Web3ResponseMessage_1.Web3ResponseMessage({\n                    id: message.id,\n                    response: {\n                        method: message.request.method,\n                        errorMessage: err.message\n                    }\n                }));\n            }\n        }));\n    }\n    publishWeb3RequestCanceledEvent(id) {\n        const message = Web3RequestCanceledMessage_1.Web3RequestCanceledMessage(id);\n        this.subscriptions.add(this.publishEvent(\"Web3RequestCanceled\", message, false).subscribe());\n    }\n    publishEvent(event, message, callWebhook) {\n        const secret = this.session.secret;\n        return new rxjs_1.Observable(subscriber => {\n            aes256gcm\n                .encrypt(JSON.stringify(Object.assign(Object.assign({}, message), { origin: location.origin })), secret)\n                .then((encrypted) => {\n                subscriber.next(encrypted);\n                subscriber.complete();\n            });\n        }).pipe(operators_1.mergeMap((encrypted) => {\n            return this.connection.publishEvent(event, encrypted, callWebhook);\n        }));\n    }\n    handleIncomingEvent(event) {\n        try {\n            this.subscriptions.add(aes256gcm\n                .decrypt(event.data, this.session.secret)\n                .pipe(operators_1.map(c => JSON.parse(c)))\n                .subscribe({\n                next: json => {\n                    const message = Web3ResponseMessage_1.isWeb3ResponseMessage(json) ? json : null;\n                    if (!message) {\n                        return;\n                    }\n                    this.handleWeb3ResponseMessage(message);\n                },\n                error: () => {\n                    var _a;\n                    (_a = this.walletLinkAnalytics) === null || _a === void 0 ? void 0 : _a.sendEvent(init_1.EVENTS.GENERAL_ERROR, { message: 'Had error decrypting', value: 'incomingEvent' });\n                }\n            }));\n        }\n        catch (_a) {\n            return;\n        }\n    }\n    handleWeb3ResponseMessage(message) {\n        const { response } = message;\n        if (Web3Response_1.isRequestEthereumAccountsResponse(response)) {\n            Array.from(WalletLinkRelay.accountRequestCallbackIds.values()).forEach(id => this.invokeCallback(Object.assign(Object.assign({}, message), { id })));\n            WalletLinkRelay.accountRequestCallbackIds.clear();\n            return;\n        }\n        this.invokeCallback(message);\n    }\n    invokeCallback(message) {\n        const callback = this.relayEventManager.callbacks.get(message.id);\n        if (callback) {\n            callback(message.response);\n            this.relayEventManager.callbacks.delete(message.id);\n        }\n    }\n    switchEthereumChain(chainId) {\n        return this.sendRequest({\n            method: Web3Method_1.Web3Method.switchEthereumChain,\n            params: {\n                chainId\n            }\n        });\n    }\n}\nWalletLinkRelay.accountRequestCallbackIds = new Set();\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"resetAndReload\", null);\n__decorate([\n    bind_decorator_1.default\n], WalletLinkRelay.prototype, \"handleIncomingEvent\", null);\nexports.WalletLinkRelay = WalletLinkRelay;\n"]},"metadata":{},"sourceType":"script"}